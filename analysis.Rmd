---
title: "Wind Turbine and Bird Analysis"
maketitle: true
author: Sarah Tang
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(messages = FALSE, warnings = FALSE, cache = TRUE)
```

## Set Up
Fifty Stater: https://github.com/wmurphyrd/fiftystater
USAboundaries: https://lincolnmullen.com/software/usaboundaries/
I load in libraries to make API calls, use data visualization packages, and overlay visuals with maps.

```{r include=FALSE, echo=FALSE}
devtools::install_github("wmurphyrd/fiftystater")

library(tidyverse)
library(dplyr)
library(ggplot2)
library(sf)
library(tmap)
library(tmaptools)
library(USAboundaries)
library(httr)
library(jsonlite)
library(viridis)
library(mapproj)
library(magrittr)
library(fiftystater)
library(purrr)
```

## Introduction
This module aims to examine and better understand how wind turbine development impacts bird populations, specifically for the whooping crane (Grus americana), one of the most endangered birds in North America. As land use needed for wind energy increases, it is crucial to understand the relationship between wind turbines, both while operating and installing, and animals' responses and wildlife habitat.

Whooping crane corridor - https://www.sciencebase.gov/catalog/item/5a314a72e4b08e6a89d707e0
Whooping crane - https://www.arcgis.com/home/item.html?id=7d27571bc3454a1c91edf665c67b9c3e

## Loading in files
Data access
```{r echo=FALSE}
wind_turbines <- st_read("uswtdbSHP/uswtdb_v1_2_20181001.shp", quiet = TRUE)
whooping_crane_corridors <-
  st_read("WHCR_corridors/WHCR_corridors.shp", quiet = TRUE)
```

# Mapping Wind Turbines and Whooping Crane Migratory Paths
Next, I plot the maps of the location of wind turbines and whooping crane patterns using the `tm_shape` command. Data preparation and initial data visualization.
```{r}
tm_shape(wind_turbines) +
  tm_dots()

data("World")
bb_us <- bb("United States", projection = "eck4")

tm_shape(World, bbox = bb_us) +
  tm_polygons() +
  tm_shape(wind_turbines) +
  tm_dots() + 
  labs(title = "Locations of Wind Turbines in the US")

```


```{r}
devtools::install_github("ropensci/USAboundariesData")
USAboundaries::install_data_package

wind_belt <- USAboundaries::us_states(states = c("Texas", "Wyoming",
                                  "Kansas", "Montana",
                                  "Nebraska", "Colorado",
                                  "North Dakota", "New Mexico",
                                  "South Dakota", "Iowa",
                                  "Oklahoma", "Minnesota"),
                       resolution = "high")
 plot(st_geometry(wind_belt))

tm_shape(wind_belt) +
  tm_polygons() +
  tm_shape(wind_turbines) +
  tm_dots()


```


```{r}
ggplot(whooping_crane_corridors) + geom_sf() +
  ggtitle("Whooping Crane Migration Corridor")

tm_shape(wind_belt) +
  tm_polygons("state_name") +
  tm_shape(whooping_crane_corridors) +
  tm_polygons() +
  labs(title = "Whooping Crane Migration Corridor through the US")

```

I then overlay the two maps onto a map of the United States.
```{r}
tmap_mode(mode = "plot") #change mode to plot

tm_shape(wind_belt) +
  tm_polygons("state_name") +
  tm_shape(whooping_crane_corridors) +
  tm_polygons() +
  tm_shape(wind_turbines) +
  tm_dots() +
  labs(title = "Whooping Crane Migration Corridor vs. Wind Turbines Location")
  
```

### Are there overlaps in the location of wind turbine sites and whooping crane migratory patterns?
*Yes! By overlaying the three different shape files, we can see that where there is high wind in the United States (in the midwest), is where wind turbines are primarily located.*

#Wind Turbine Analysis
From USGS and USWTDB, I read in a csv with the location of land-based and offshore wind turbines. Specifically, I will analyze each of projects information, specifically regarding state, height, and year put in place.
Data found here: https://eerscmap.usgs.gov/uswtdb/data/
Metadata: https://eerscmap.usgs.gov/uswtdb/assets/data/uswtdb_v1_2_20181001.xml

```{r}
full_wind_csv <- read_csv("uswtdbCSV/uswtdb_v1_2_20181001.csv")
full_wind_csv

total_num_turbines <- nrow(full_wind_csv)
total_num_turbines
```
*Our dataset looks at a total of 58,185 tubines.*

Analysis - group by state, graph height (and get none NA vals), what heights

t_hh refers to turbine hub height in m
t_rsa refers to turbine rotor swept area in square meters
t_ttlh refers to the height of the wind turbine from the ground to the tip of a vertically extended blade above the tower. (t_ttlh = t_hh + 1/2 rotor diameter)
t_conf_atr referes to level of confidence in the turbine's attributes from low to high
1. no confidence: no information found
2. partial confidence: incomplete information or discrepancies found across data sources
3. full confidence: consistent information across multiple data sources

```{r}
wind_csv <- full_wind_csv %>% dplyr::select(case_id,
                    state = t_state,
                    site_name = p_name,
                    site_year = p_year,
                    total_turbines = p_tnum,
                    rotor_swept_area = t_rsa,
                    hub_height = t_hh,
                    rotor_dia = t_rd,
                    total_height = t_ttlh,
                    confidence = t_conf_atr)
wind_csv
```

State analysis - number of turbines per states
```{r}
turbine_per_state <- wind_csv %>%
  filter(state != "GU") %>% #not real states: GU and PR
  filter(state != "PR") %>%
  count(state)

turbine_per_state %>% arrange(desc(n))
```
*From this analysis, we can see that Texas has the most turbines as wind generation there continues to grow. After Texas and California, the states with the next highest number of turbines are IA (Iowa), OK (Oklahoma) - right above Texas, and KS (Kansas). All of these states fall within the wind belt.*

Next, I map the number of turbines per state using the Fifty States data. When using this data, the states are written lowercase and spelled out, not in abbreviations. As a result, it is important to convert each state id so that it correlates with the map.
```{r}
data("fifty_states")
state_abbs <- tibble(state = str_to_lower(state.name), abb = state.abb)
full_turbines <- left_join(turbine_per_state,
                           state_abbs, by = c("state" = "abb")) %>%
  rename(id = state) %>%
  rename(full_state = state.y) %>%
  rename(num_turbines = n)

ggplot(full_turbines, aes(map_id = full_state)) +
  geom_map(aes(fill = num_turbines), map = fifty_states) +
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_fill_viridis() +
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  labs(title = "Number of Turbines per state in the US", x = "", y = "")
```

## Filter wind turbines by height
Whooping cranes fly during migration between 15 and 1800 meters above the ground. They usually fly around 500 m off the ground (Source: https://journeynorth.org/tm/crane/MigrationDay_BJohns.html).

```{r}
wind_belt_states <- c("Texas", "Wyoming",
              "Kansas", "Montana",
              "Nebraska", "Colorado",
              "North Dakota", "New Mexico",
              "South Dakota", "Iowa",
              "Oklahoma", "Minnesota")

wind_belt_abb <- c("TX", "NM", "WY", "KS",
                   "NE", "ND", "SD", "CO",
                   "IA", "MN", "OK")

turbines_by_height <- wind_csv %>%
  filter(rotor_swept_area != -9999.00) %>%
  filter(total_height < 1800) %>% #top of rotor area
  filter(is.element(state, wind_belt_abb)) %>%
  mutate(bottom = total_height - rotor_dia) %>%
  filter(bottom > 15) #botom of rotor area

percent_dangerous <- nrow(turbines_by_height) / total_num_turbines
percent_dangerous * 100

```

*56 percent of turbines could potentially be dangerous for whooping crane populations based on their rotor height. Wind turbine siting is extremely important in order to limit the number of bird deaths, especially for species that are already endangered.*


#Other bird populations?

Just want to look through api list for genus and species of birds and bats (not necessarily ones that are already extinct)
```{r}
genus <- "Grus"
species <- "americana"
api_call <- paste0("http://api.iucnredlist.org/index/species/",
                   genus, "-", species, ".json")

resp <- httr::GET(api_call)
resp

status <- httr::status_code(resp)

out <- httr::content(resp, as = "text")
df <- jsonlite::fromJSON(out)
rationale <- df$rationale
df
```

Working with API and token

All species

Gettings all the species within the United States.
Interaction with an api
```{r}
token <- ("9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee")
token
website <- ("http://apiv3.iucnredlist.org/api/v3/")
website

resp_test <- httr::GET(paste0(website, "country/getspecies/US?token=", token))
out_test <- httr::content(resp_test, as = "text")
df_us <- jsonlite::fromJSON(out_test)

df_us_final <- plyr::ldply(df_us, data.frame)
df_us_final %>%
  select(taxonid, scientific_name, category) %>%
  filter(!is.na(scientific_name))
```

Getting all 10 pages of species so that I can match them up with the species found within the United States
```{r}
api_calls <- purrr::map((0:10), function(page_num){paste0("http://apiv3.iucnredlist.org/api/v3/species/page/", page_num, "?token=9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee")})

resp2 <- purrr::map(api_calls[1:10], function(url){
  Sys.sleep(0.5)
  httr::GET(url)
})

out <- purrr::map(resp2, httr::content, as = "text")
df_page <- purrr::map(out, jsonlite::fromJSON)
df_page

all_df <- plyr::ldply(df_page, data.frame)
all_df <- all_df %>%
  mutate(scientific_name = result.scientific_name)
all_df
```

Combine all species with the US species
Use of regular expressions to extract the species from the scientific name
```{r}
us_all <- left_join(df_us_final, all_df, by = "scientific_name")

us_birds <- us_all %>%
  filter(!is.na(scientific_name)) %>%
  filter(result.class_name == "AVES") %>%
  select(scientific_name, class = result.class_name,
         order = result.order_name,
         genus = result.genus_name, category) %>%
  mutate(species = stringr::str_extract(scientific_name, "(\\s+\\S+)"))
us_birds
```

Getting rationale for each
Custom R function to create an api call given the genus and species so that I can get the rationale for each bird within the United States

```{r}

api_call_threats <- paste0("http://apiv3.iucnredlist.org/api/v3/threats/species/name/", genus, "%20", species, "?token=", token)
api_call_threats

api_threat <- function(genus, species) {
  api_call_threats <- paste0("http://apiv3.iucnredlist.org/api/v3/threats/species/name/", 
                             genus, "%20", species, "?token=", token)
  response <- httr::GET(api_call_threats)
  status <- httr::status_code(response)
  out <- httr::content(response, as = "text")
  df <- jsonlite::fromJSON(out)
  df
}

df_bird_threats <- map2_dfr(us_birds$genus[1:5], us_birds$species[1:5], api_threat)
df_bird_threats


api_fn <- function(genus, species) {
  api_call <- paste0("http://api.iucnredlist.org/index/species/", genus, "-", species, ".json")
  Sys.sleep(0.5)
  
  out <- httr::content(resp, as = "text")
  df <- jsonlite::fromJSON(out)
  rationale <- df$rationale
  
  data_frame(Genus = genus, Species = species, API = api_call, rationale = rationale, status_code = status)
}

df_all_birds_us <- map2_dfr(us_birds$genus[1:2], us_birds$species[1:2], api_fn)
df_all_birds_us
```

Instead of doing the above, I can extract threats for each species and parse through those?

Overall, the next steps are to further examine how positioning and siting can alter migration patterns of whooping cranes as well as the other bird species listed above.